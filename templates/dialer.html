<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Phone Dialer</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .phone-container {
            max-width: 420px;
            margin: 0 auto;
            height: 100vh;
            background: #1c1c1e;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Status Bar */
        .status-bar {
            height: 44px;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
        }

        .status-bar .time {
            font-weight: 600;
        }

        .status-bar .icons {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background: #1c1c1e;
            border-bottom: 1px solid #38383a;
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: #8e8e93;
            cursor: pointer;
            transition: color 0.2s;
            padding: 5px 20px;
        }

        .nav-tab.active {
            color: #007aff;
        }

        .nav-tab-icon {
            font-size: 24px;
        }

        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            background: #000;
        }

        /* Contacts List */
        .contacts-list {
            display: none;
        }

        .contacts-list.active {
            display: block;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #38383a;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact-item:active {
            background: #2c2c2e;
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .contact-number {
            font-size: 14px;
            color: #8e8e93;
            font-family: monospace;
        }

        .contact-description {
            font-size: 13px;
            color: #636366;
            margin-top: 2px;
        }

        /* Keypad */
        .keypad {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .keypad.active {
            display: flex;
        }

        .dial-display {
            padding: 30px 20px;
            text-align: center;
            background: #000;
        }

        .dialed-number {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 2px;
            min-height: 40px;
            color: #fff;
        }

        .dial-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            flex: 1;
        }

        .dial-btn {
            aspect-ratio: 1;
            border-radius: 50%;
            background: #2c2c2e;
            border: none;
            color: #fff;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            position: relative;
        }

        .dial-btn:active {
            background: #48484a;
            transform: scale(0.95);
        }

        .dial-btn-letters {
            font-size: 11px;
            color: #8e8e93;
            margin-top: -5px;
            letter-spacing: 2px;
        }

        .dial-btn.special {
            font-size: 24px;
            background: transparent;
        }

        .dial-btn.call {
            background: #34c759;
            grid-column: 2;
        }

        .dial-btn.call:active {
            background: #2fb350;
        }

        .dial-btn.delete {
            background: transparent;
        }

        /* Call Screen */
        .call-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #1c1c1e;
            justify-content: space-between;
            padding: 60px 0 40px;
        }

        .call-screen.active {
            display: flex;
        }

        .call-info {
            text-align: center;
            padding: 40px 20px;
        }

        .caller-avatar {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .caller-name {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .caller-number {
            font-size: 18px;
            color: #8e8e93;
            font-family: monospace;
            margin-bottom: 10px;
        }

        .call-status {
            font-size: 16px;
            color: #8e8e93;
            margin-top: 20px;
        }

        .call-transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
            margin: 20px 0;
        }

        .transcript-bubble {
            background: #2c2c2e;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .transcript-bubble.agent {
            background: #007aff;
            margin-left: auto;
        }

        .transcript-speaker {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        .transcript-text {
            font-size: 15px;
            line-height: 1.4;
        }

        .call-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 0 40px;
            margin-bottom: 30px;
        }

        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            border: none;
            background: #48484a;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin: 0 auto;
        }

        .call-control-btn:active {
            transform: scale(0.9);
        }

        .call-control-btn.mute.active {
            background: #fff;
            color: #000;
        }

        .call-control-btn.end {
            background: #ff3b30;
            width: 70px;
            height: 70px;
            border-radius: 35px;
        }

        .call-control-btn.end:active {
            background: #e62e24;
        }

        /* Recent Calls */
        .recents-list {
            display: none;
        }

        .recents-list.active {
            display: block;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #38383a;
            cursor: pointer;
        }

        .recent-item:active {
            background: #2c2c2e;
        }

        .recent-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .recent-info {
            flex: 1;
        }

        .recent-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .recent-time {
            font-size: 13px;
            color: #8e8e93;
        }

        .recent-status {
            font-size: 13px;
            color: #ff3b30;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .calling-animation {
            animation: pulse 1.5s infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #8e8e93;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <span class="time" id="status-time">9:41</span>
            <div class="icons">
                <span>üì∂</span>
                <span>üì°</span>
                <span>üîã</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab" onclick="switchTab('contacts')">
                <div class="nav-tab-icon">üë•</div>
                <div>Contacts</div>
            </div>
            <div class="nav-tab active" onclick="switchTab('keypad')">
                <div class="nav-tab-icon">‚å®Ô∏è</div>
                <div>Keypad</div>
            </div>
            <div class="nav-tab" onclick="switchTab('recents')">
                <div class="nav-tab-icon">üïí</div>
                <div>Recents</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Contacts List -->
            <div class="contacts-list" id="contacts-view">
                <div class="contact-item" onclick="callContact('restaurant')">
                    <div class="contact-avatar" style="background: #FF6B6B;">üçî</div>
                    <div class="contact-info">
                        <div class="contact-name">GourmetEats Restaurant</div>
                        <div class="contact-number">+1-555-FOOD-001</div>
                        <div class="contact-description">Order delicious food</div>
                    </div>
                </div>

                <div class="contact-item" onclick="callContact('hospital')">
                    <div class="contact-avatar" style="background: #4ECDC4;">üè•</div>
                    <div class="contact-info">
                        <div class="contact-name">HealthCare Plus Hospital</div>
                        <div class="contact-number">+1-555-HEAL-002</div>
                        <div class="contact-description">Book medical appointments</div>
                    </div>
                </div>

                <div class="contact-item" onclick="callContact('techsupport')">
                    <div class="contact-avatar" style="background: #95E1D3;">üíª</div>
                    <div class="contact-info">
                        <div class="contact-name">TechFix Support Center</div>
                        <div class="contact-number">+1-555-TECH-003</div>
                        <div class="contact-description">Get technical help</div>
                    </div>
                </div>

                <div class="contact-item" onclick="callContact('travel')">
                    <div class="contact-avatar" style="background: #F38181;">‚úàÔ∏è</div>
                    <div class="contact-info">
                        <div class="contact-name">SkyHigh Travel Agency</div>
                        <div class="contact-number">+1-555-TRIP-004</div>
                        <div class="contact-description">Book flights and hotels</div>
                    </div>
                </div>

                <div class="contact-item" onclick="callContact('support')">
                    <div class="contact-avatar" style="background: #AA96DA;">üìû</div>
                    <div class="contact-info">
                        <div class="contact-name">Universal Customer Service</div>
                        <div class="contact-number">+1-555-HELP-005</div>
                        <div class="contact-description">General inquiries</div>
                    </div>
                </div>
            </div>

            <!-- Keypad -->
            <div class="keypad active" id="keypad-view">
                <div class="dial-display">
                    <div class="dialed-number" id="dialed-number"></div>
                </div>
                <div class="dial-buttons">
                    <button class="dial-btn" onclick="dialNumber('1')">
                        1
                        <span class="dial-btn-letters"></span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('2')">
                        2
                        <span class="dial-btn-letters">ABC</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('3')">
                        3
                        <span class="dial-btn-letters">DEF</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('4')">
                        4
                        <span class="dial-btn-letters">GHI</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('5')">
                        5
                        <span class="dial-btn-letters">JKL</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('6')">
                        6
                        <span class="dial-btn-letters">MNO</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('7')">
                        7
                        <span class="dial-btn-letters">PQRS</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('8')">
                        8
                        <span class="dial-btn-letters">TUV</span>
                    </button>
                    <button class="dial-btn" onclick="dialNumber('9')">
                        9
                        <span class="dial-btn-letters">WXYZ</span>
                    </button>
                    <button class="dial-btn special" onclick="dialNumber('*')">‚ú±</button>
                    <button class="dial-btn" onclick="dialNumber('0')">
                        0
                        <span class="dial-btn-letters">+</span>
                    </button>
                    <button class="dial-btn special" onclick="dialNumber('#')">#</button>
                    <div></div>
                    <button class="dial-btn call" onclick="makeCall()">üìû</button>
                    <button class="dial-btn delete" onclick="deleteNumber()">‚å´</button>
                </div>
            </div>

            <!-- Recent Calls -->
            <div class="recents-list" id="recents-view">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Call Screen -->
            <div class="call-screen" id="call-screen">
                <div class="call-info">
                    <div class="caller-avatar" id="caller-avatar">üçî</div>
                    <div class="caller-name" id="caller-name">GourmetEats Restaurant</div>
                    <div class="caller-number" id="caller-number">+1-555-FOOD-001</div>
                    <div class="call-status calling-animation" id="call-status">Calling...</div>
                </div>

                <div class="call-transcript-container" id="call-transcript">
                    <!-- Transcript will appear here -->
                </div>

                <div class="call-controls">
                    <button class="call-control-btn mute" id="mute-btn" onclick="toggleMute()">
                        üé§
                    </button>
                    <button class="call-control-btn end" onclick="endCall()">
                        üìû
                    </button>
                    <button class="call-control-btn" onclick="toggleSpeaker()">
                        üîä
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentCallId = null;
        let currentService = null;
        let dialedNumber = '';
        let isMuted = false;
        let audioContext = null;
        let micStream = null;
        let recentCalls = [];

        const CONTACTS = {
            'restaurant': {
                name: 'GourmetEats Restaurant',
                number: '+1-555-FOOD-001',
                icon: 'üçî',
                color: '#FF6B6B',
                service: 'restaurant'
            },
            'hospital': {
                name: 'HealthCare Plus Hospital',
                number: '+1-555-HEAL-002',
                icon: 'üè•',
                color: '#4ECDC4',
                service: 'hospital'
            },
            'techsupport': {
                name: 'TechFix Support Center',
                number: '+1-555-TECH-003',
                icon: 'üíª',
                color: '#95E1D3',
                service: 'techsupport'
            },
            'travel': {
                name: 'SkyHigh Travel Agency',
                number: '+1-555-TRIP-004',
                icon: '‚úàÔ∏è',
                color: '#F38181',
                service: 'travel'
            },
            'support': {
                name: 'Universal Customer Service',
                number: '+1-555-HELP-005',
                icon: 'üìû',
                color: '#AA96DA',
                service: 'support'
            }
        };

        // Update time
        function updateTime() {
            const now = new Date();
            const hours = now.getHours() % 12 || 12;
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('status-time').textContent = `${hours}:${minutes}`;
        }
        updateTime();
        setInterval(updateTime, 60000);

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.contacts-list, .keypad, .recents-list').forEach(v => v.classList.remove('active'));
            
            event.target.closest('.nav-tab').classList.add('active');
            
            if (tab === 'contacts') {
                document.getElementById('contacts-view').classList.add('active');
            } else if (tab === 'keypad') {
                document.getElementById('keypad-view').classList.add('active');
            } else if (tab === 'recents') {
                document.getElementById('recents-view').classList.add('active');
                loadRecents();
            }
        }

        // Dial pad functions
        function dialNumber(num) {
            dialedNumber += num;
            document.getElementById('dialed-number').textContent = dialedNumber;
        }

        function deleteNumber() {
            dialedNumber = dialedNumber.slice(0, -1);
            document.getElementById('dialed-number').textContent = dialedNumber;
        }

        function makeCall() {
            if (!dialedNumber) return;
            
            // Try to match dialed number to a contact
            const contact = Object.values(CONTACTS).find(c => 
                c.number.replace(/[^0-9]/g, '').includes(dialedNumber.replace(/[^0-9]/g, ''))
            );
            
            if (contact) {
                callContact(contact.service);
            } else {
                alert('Number not recognized. Please call a contact from the list.');
            }
        }

        function callContact(contactId) {
            const contact = CONTACTS[contactId];
            currentService = contactId;
            
            // Update call screen
            document.getElementById('caller-avatar').textContent = contact.icon;
            document.getElementById('caller-avatar').style.background = contact.color;
            document.getElementById('caller-name').textContent = contact.name;
            document.getElementById('caller-number').textContent = contact.number;
            document.getElementById('call-status').textContent = 'Calling...';
            document.getElementById('call-transcript').innerHTML = '';
            
            // Hide other views, show call screen
            document.querySelectorAll('.contacts-list, .keypad, .recents-list').forEach(v => v.style.display = 'none');
            document.getElementById('call-screen').classList.add('active');
            
            // Start the actual call
            startCall(contactId);
        }

        async function startCall(service) {
            console.log('Starting call to:', service);
            
            try {
                // Request microphone
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });
                
                micStream = stream;
                console.log('Microphone access granted');
                
                document.getElementById('call-status').textContent = 'Connecting...';
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (e) => {
                    if (!isMuted && currentCallId) {
                        const audioData = e.inputBuffer.getChannelData(0);
                        const int16Array = new Int16Array(audioData.length);
                        for (let i = 0; i < audioData.length; i++) {
                            int16Array[i] = Math.max(-32768, Math.min(32767, audioData[i] * 32768));
                        }
                        
                        socket.emit('send_audio', {
                            call_id: currentCallId,
                            audio: btoa(String.fromCharCode.apply(null, new Uint8Array(int16Array.buffer)))
                        });
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                // Start call via socket
                socket.emit('start_call', { service: service });
                
            } catch (err) {
                console.error('Error starting call:', err);
                alert('Could not access microphone. Please allow microphone access and try again.');
                backToDialer();
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) {
                btn.classList.add('active');
                btn.textContent = 'üîá';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üé§';
            }
        }

        function toggleSpeaker() {
            // Placeholder for speaker toggle
            alert('Speaker toggle - functionality can be added');
        }

        function endCall() {
            if (currentCallId) {
                socket.emit('end_call', { call_id: currentCallId });
            }
            
            // Add to recents
            if (currentService) {
                const contact = CONTACTS[currentService];
                recentCalls.unshift({
                    ...contact,
                    time: new Date(),
                    duration: '00:45',
                    type: 'outgoing'
                });
                if (recentCalls.length > 20) recentCalls.pop();
                localStorage.setItem('recentCalls', JSON.stringify(recentCalls));
            }
            
            // Cleanup
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            
            currentCallId = null;
            isMuted = false;
            
            backToDialer();
        }

        function backToDialer() {
            document.getElementById('call-screen').classList.remove('active');
            document.querySelectorAll('.contacts-list, .keypad, .recents-list').forEach(v => v.style.display = 'block');
            document.getElementById('keypad-view').classList.add('active');
            dialedNumber = '';
            document.getElementById('dialed-number').textContent = '';
            currentService = null;
        }

        function loadRecents() {
            const stored = localStorage.getItem('recentCalls');
            if (stored) {
                recentCalls = JSON.parse(stored);
            }
            
            const recentsView = document.getElementById('recents-view');
            if (recentCalls.length === 0) {
                recentsView.innerHTML = '<div class="loading">No recent calls</div>';
                return;
            }
            
            recentsView.innerHTML = recentCalls.map(call => {
                const time = new Date(call.time);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                
                return `
                    <div class="recent-item" onclick="callContact('${call.service}')">
                        <div class="recent-icon" style="background: ${call.color};">${call.icon}</div>
                        <div class="recent-info">
                            <div class="recent-name">${call.name}</div>
                            <div class="recent-time">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Socket events
        socket.on('call_started', (data) => {
            currentCallId = data.call_id;
            document.getElementById('call-status').textContent = 'Connected';
            document.getElementById('call-status').classList.remove('calling-animation');
            console.log('Call started:', data);
        });

        socket.on('call_transcript', (data) => {
            const transcript = document.getElementById('call-transcript');
            
            const bubble = document.createElement('div');
            bubble.className = 'transcript-bubble';
            if (data.speaker === 'Agent') {
                bubble.classList.add('agent');
            }
            
            bubble.innerHTML = `
                <div class="transcript-speaker">${data.speaker}</div>
                <div class="transcript-text">${data.text}</div>
            `;
            
            transcript.appendChild(bubble);
            transcript.scrollTop = transcript.scrollHeight;
        });

        socket.on('call_ended', (data) => {
            console.log('Call ended:', data);
            setTimeout(() => {
                if (document.getElementById('call-screen').classList.contains('active')) {
                    endCall();
                }
            }, 2000);
        });

        socket.on('audio_data', (data) => {
            // Play received audio (implementation depends on your audio setup)
            console.log('Received audio data');
        });

        // Load recents on page load
        const stored = localStorage.getItem('recentCalls');
        if (stored) {
            recentCalls = JSON.parse(stored);
        }
    </script>
</body>
</html>
